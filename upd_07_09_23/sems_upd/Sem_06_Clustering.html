

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Кластеризация &#8212; FSR. Machine learning.</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/documentation_options.js"></script>
    <script src="../../_static/searchtools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/copybutton_funcs.js"></script>
    <script src="../../_static/jquery-3.6.0.js"></script>
    <script src="../../_static/sphinx-thebe.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore-1.13.1.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js"></script>
    <script src="../../_static/scripts/bootstrap.js"></script>
    <script src="../../_static/scripts/pydata-sphinx-theme.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'upd_07_09_23/sems_upd/Sem_06_Clustering';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/FSRlogo.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/FSRlogo.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Машинное обучение
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Regression.html">Linear Model (LM)</a></li>











<li class="toctree-l1"><a class="reference internal" href="../../regression_seminar.html">SGD</a></li>



<li class="toctree-l1"><a class="reference internal" href="../../logistic_seminar.html">Log-Reg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SVM_seminar.html">SVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../KNN_seminar.html">KNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../decision_trees_seminar.html">DT</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fupd_07_09_23/sems_upd/Sem_06_Clustering.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/upd_07_09_23/sems_upd/Sem_06_Clustering.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Кластеризация</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Кластеризация</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Методы понижения размерности</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pca">PCA (Метод главных компонент)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Максимизация дисперсии выборки после понижения размерности</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Пример с Титаником</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Без стандартизации</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Со стандартизацией</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Как выбирать оптимальное число  компонент</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">По доле объясняемой дисперсии</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">По правилу локтя</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Перестановочный метод</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Проблемы  PCA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Интересное направление в данных может не совпадать с направлением максимальной дисперсии.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Выбранные оси могут вообще не подходить для нашей задачи</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Недостатки линейного PCA</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-pca">Kernel PCA Ядровой (нелинейный) метод главных компонент</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-trick">Kernel trick</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Пример</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Методы, основанные на сохранении расстояний</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne-t-distributed-stochastic-neighbor-embedding">t-SNE (t-distributed stochastic neighbor embedding)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Описываем расстояния в исходном пространстве</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Описываем расстояния в пространстве низкой размерности</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Оптимизируем низкоразмерное представление</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Пример применения</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne">Важные параметры t-SNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#perplexity">perplexity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metric">metric</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate">learning_rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Проблемы t-SNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Стохастичность</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Добавление новых точек</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Расстояния между кластерами точек могут ничего не значить (плохо сохраняются далекие расстояния)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Размеры кластеров ничего не значат</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Можно увидеть артефактные кластеры</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Можно увидеть не ту структуру, которая по идее должна быть</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Использование для кластеризации</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#umap">UMAP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap-iris">UMAP - пример использования на датасете IRIS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Использование понижения размерности для ускорения обучения</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>Кластеризация<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h1>
<img src ="https://edunet.kea.su/repo/EduNet-content/L01/out/clustering_task.png" width="600" >
<p>Кластеризация — <strong>разбиение множества входных сигналов на классы при том, что ни количество, ни признаки классов заранее не известны</strong>. После обучения модель способна определять, к какому классу относится входной сигнал. Модель также может сигнализировать о том, что входной сигнал не относится ни к одному из выделенных классов — это является признаком новых, отсутствующих в обучающей выборке данных. Таким образом, подобная модель может выявлять новые, неизвестные ранее классы сигналов. Соответствие между классами, выделенными сетью, и классами, существующими в предметной области, устанавливается человеком.</p>
<p>Относится к задачам <strong>обучения без учителя</strong>.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id2">
<h1>Методы понижения размерности<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h1>
<p>Примените методы понижения размерности: PCA, t-SNE и UMAP к изображениям клеток крови из датасета BloodMNIST. Отобразите проекцию данных на двумерное пространство, так как это допускает наиболее простую визуализацию полученного результата (воспользуйтесь <a class="reference external" href="https://seaborn.pydata.org/generated/seaborn.scatterplot.html"><code class="docutils literal notranslate"><span class="pre">sns.scatterplot</span></code></a>).  Какой метод позволяет лучше разделить данные в пространстве? Опишите ваши наблюдения.</p>
<p>Произведем загрузку данных:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install -q gdown
<span class="o">!</span>pip install -q umap-learn
<span class="o">!</span>pip install -q --upgrade git+https://github.com/MedMNIST/MedMNIST.git
<span class="o">!</span>wget -q https://edunet.kea.su/repo/EduNet-web_dependencies/Exercises/EX04/dataset_without_pytorch.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Yellow">DEPRECATION: pyodbc 4.0.0-unsupported has a non-standard version number. pip 23.3 will enforce this behaviour change. A possible replacement is to upgrade to a newer version of pyodbc or contact the author to suggest that they release a version with a conforming version number. Discussion can be found at https://github.com/pypa/pip/issues/12063</span>

</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Yellow">DEPRECATION: pyodbc 4.0.0-unsupported has a non-standard version number. pip 23.3 will enforce this behaviour change. A possible replacement is to upgrade to a newer version of pyodbc or contact the author to suggest that they release a version with a conforming version number. Discussion can be found at https://github.com/pypa/pip/issues/12063</span>

</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>^C
<span class=" -Color -Color-Red">ERROR: Operation cancelled by user</span>

</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>zsh:1: command not found: wget
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;sklearn.externals.joblib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">joblib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">umap</span>
<span class="kn">import</span> <span class="nn">medmnist</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">manifold</span>
<span class="kn">from</span> <span class="nn">medmnist</span> <span class="kn">import</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">Evaluator</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="pca">
<h2>PCA (Метод главных компонент)<a class="headerlink" href="#pca" title="Permalink to this heading">#</a></h2>
<p>Метод главных компонент (Principal Component Analysys, PCA) — простейший линейный метод снижения размерности, описан <a class="reference external" href="http://pca.narod.ru/pearson1901.pdf">Пирсоном в 1901 году</a>.</p>
<p>Идея заключается в преобразовании <span class="math notranslate nohighlight">\(D\)</span> исходных признаков таким образом, чтобы получить <span class="math notranslate nohighlight">\(d\)</span> признаков, содержащих как можно больше информации из исходных признаков:</p>
<div class="math notranslate nohighlight">
\[\large z_{ij} = \sum^D_{k=1}w_{jk}x_{ik},\]</div>
<p>где: <span class="math notranslate nohighlight">\(\; z_{ij}\)</span> — новые признаки (<span class="math notranslate nohighlight">\(d\)</span> штук),</p>
<p><span class="math notranslate nohighlight">\(\qquad x_{ik}\)</span> — исходные признаки (<span class="math notranslate nohighlight">\(D\)</span> штук),</p>
<p><span class="math notranslate nohighlight">\(\qquad w_{jk}\)</span> — вклад исходного <span class="math notranslate nohighlight">\(k\)</span>-го признака в новый <span class="math notranslate nohighlight">\(j\)</span>-й.</p>
<p>Запишем линейное преобразование исходного признакового пространства в <strong>матричном виде</strong>.</p>
<p>Требование — ортогональность матрицы <span class="math notranslate nohighlight">\(W: W^TW = I\)</span>, где <span class="math notranslate nohighlight">\(I\)</span> — единичная матрица.</p>
<p>Получение новых признаков <span class="math notranslate nohighlight">\(Z\)</span> осуществляется домножением исходных признаков <span class="math notranslate nohighlight">\(X\)</span> на матрицу <span class="math notranslate nohighlight">\(W: XW=Z\)</span>.</p>
<p>Следовательно, <span class="math notranslate nohighlight">\(X=ZW^T\)</span></p>
<p>Задача: <span class="math notranslate nohighlight">\(\displaystyle ||X-ZW^T||^2 \rightarrow \min_{W}\)</span></p>
<div class="math notranslate nohighlight">
\[\]</div>
<section id="id3">
<h3>Максимизация дисперсии выборки после понижения размерности<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>Рассмотрим простой пример для понимания интуиции, которая стоит за методом главных компонент.</p>
<p>У нас есть выборка объектов с двумя признаками <span class="math notranslate nohighlight">\(x_1\)</span> и <span class="math notranslate nohighlight">\(x_2\)</span>, отобразим их на плоскости. Мы хотим, чтобы у нас был только один признак, который характеризует наши данные. Тогда наша задача — провести прямую через наши точки так, чтобы она наилучшим образом характеризовала наши данные</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/pca_dataset_example.png" width="400"/><p>Проведем прямую вдоль максимального изменения данных и спроецируем точки на нее. Это и будет наша первая главная компонента.</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/first_component_example.png" width="400"/><p>Теперь мы можем использовать только один признак, который лежит на новой оси, а любые отклонения от нее это просто шум (в действительности, определить, что является шумом в данных это нетривиальная задача).</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/proection_component.png" width="400"/><p>Это то, как можно понимать интуицию работы PCA.</p>
<p>В более многомерном случае (например, при количестве признаков 200) мы бы делали то же самое:</p>
<ol class="arabic simple">
<li><p>Выбираем направление максимального изменения данных — это первая главная компонента.</p></li>
<li><p>Если данные описаны не полностью, то выбираем еще одно направление — перпендикулярное к первому, так, чтобы описать оставшееся изменение в данных.</p></li>
<li><p>Повторяем пункт 2, пока компонент не будет достаточно, вплоть до размерности исходного пространства. При этом каждая следующая компонента будет перпендикулярна предыдущим и объяснять меньше дисперсии, чем любая из них.</p></li>
</ol>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/3d_to_2d_pca.png" width="1000"/></section>
<section id="id4">
<h3>Пример с Титаником<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<p>Чтобы понять, как использовать PCA на практике, найдем главные компоненты для датасета Titanic и посмотрим, как распределится между ними дисперсия.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="c1"># The categorical-to-numerical function</span>
<span class="c1"># Changed to automatically add column names</span>
<span class="k">def</span> <span class="nf">cat_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>  <span class="c1"># one-hot encoding</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">cat</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">binary</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Ignore features where all values equal</span>
            <span class="k">continue</span>
        <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">features</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cabin_features</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cabin</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">cabins</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cabin</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">n_cabins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cabins</span><span class="p">)</span>
        <span class="c1"># First char is the cabin_char</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cabin_char</span> <span class="o">=</span> <span class="n">cabins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">cabin_char</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span>
            <span class="n">n_cabins</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># The rest is the cabin number</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cabin_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cabins</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cabin_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Add 3 features for each passanger</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cabin_char</span><span class="p">,</span> <span class="n">cabin_num</span><span class="p">,</span> <span class="n">n_cabins</span><span class="p">])</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">dic_of_features</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Cabin_num&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">),</span>
        <span class="s2">&quot;N_cabins&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dic_of_features</span><span class="p">)</span>
    <span class="n">char_column</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Cabin_char&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]})</span>
    <span class="n">cabin_ch</span> <span class="o">=</span> <span class="n">cat_to_num</span><span class="p">(</span><span class="n">char_column</span><span class="p">[</span><span class="s2">&quot;Cabin_char&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cabin_ch</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a dataframe of raw data and returns ML model features&quot;&quot;&quot;</span>

    <span class="c1"># Initially, we build a model only on the available numerical values</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;PassengerId&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Survived&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Fare&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sex&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ticket&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cabin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Embarked&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Setting missing age values to -1</span>
    <span class="n">features</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Adding the sqrt of the fare feature</span>
    <span class="n">features</span><span class="p">[</span><span class="s2">&quot;sqrt_Fare&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Fare&quot;</span><span class="p">])</span>

    <span class="c1"># Adding gender categorical value</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]))</span>

    <span class="c1"># Adding Embarked categorical value</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Embarked&quot;</span><span class="p">]))</span>

    <span class="c1"># Split cabin</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cabin_features</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Cabin&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">features</span>
</pre></div>
</div>
</div>
</div>
<section id="id5">
<h4>Без стандартизации<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<p>Загрузим датасет и подготовим данные</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># 1. Importing the data from the .csv</span>
<span class="c1"># 2. Pre-processing the data and creating a feature set</span>
<span class="c1"># 3. Splitting the data into training and test data and labels</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://edunet.kea.su/repo/EduNet-web_dependencies/datasets/titanic.csv&quot;</span>
<span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">features</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;Survived&quot;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Полезной информацией является коэффициент объясненной дисперсии (explained variance ratio) главной компоненты. Этот коэффициент является отношением между дисперсией главной компоненты и суммой дисперсий всех главных компонент. Он указывает долю выборочной дисперсии, которая лежит вдоль оси каждой главной компоненты.</p>
<p>В модуле PCA, после <code class="docutils literal notranslate"><span class="pre">fit</span></code> можно получить explained variance ratio посредством обращения к полю <code class="docutils literal notranslate"><span class="pre">explained_variance_ratio_</span></code>, а explained variance — посредством обращения к полю <code class="docutils literal notranslate"><span class="pre">explained_variance_</span></code>.</p>
<p>Построим график с <code class="docutils literal notranslate"><span class="pre">explained_variance_ratio_</span></code> всех компонент</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># performing PCA with default number of principal components.</span>
<span class="n">titanic_pca</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">()</span>
<span class="n">titanic_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>  <span class="c1"># fitting our PCA model with the training data.</span>
<span class="c1"># calculating the explained variance of each of the components.</span>
<span class="n">evr</span> <span class="o">=</span> <span class="n">titanic_pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="c1"># We are plotting the explained variance ratios.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">evr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">evr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Variance by components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_pca</span><span class="o">.</span><span class="n">explained_variance_</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Из графика не совсем понятно, сколько компонент брать, резко доля объясняемой дисперсии меняется в районе 2-компоненты. Посмотрим, сколько компонент нужно модели</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="c1"># 1.The first thing we do is to fit a PCA model to the training set</span>
<span class="c1">#   of the Titanic dataset with n components from 1 to 10.</span>
<span class="c1"># 2.We then fit a logistic regression model to the transformed training data</span>
<span class="c1">#   and make predictions on the transformed test set.</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">titanic_pca</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="n">titanic_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

    <span class="n">x_train_reduced</span> <span class="o">=</span> <span class="n">titanic_pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_reduced</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">x_test_reduced</span> <span class="o">=</span> <span class="n">titanic_pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

    <span class="c1"># prints the number of PCA components and the score</span>
    <span class="c1"># for the corresponding model.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> first components </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_test_reduced</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Явно видим, что уже первых 7 компонент достаточно для достижения качества, которое далее не меняется. Почему же мы видим снижение уже после 2 компоненты?</p>
<p>Мы забыли сделать <strong>стандартизацию</strong> наших данных.</p>
<p>В нашем датасете переменные имеют совершенно разные масштабы. Из-за этого часть из них “перетегягивает” на себя всю дисперсию.</p>
<p>В результате по доле дисперсии судить о важности компонент нельзя.</p>
</section>
<section id="id6">
<h4>Со стандартизацией<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h4>
<p>Сделаем предварительно стандартизацию</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, we import the StandardScaler module.</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Next, we create a StandardScaler object called scaler by calling the</span>
<span class="c1"># StandardScaler() function.</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>

<span class="c1">#  We then fit the scaling model to our training data.</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="c1"># We transform your test set by applying the same scaling model.</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>

<span class="c1"># performing PCA with default number of principal components.</span>
<span class="n">titanic_pca</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">()</span>
<span class="n">titanic_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>  <span class="c1"># fitting our PCA model with the training data.</span>
</pre></div>
</div>
</div>
</div>
<p>В <code class="docutils literal notranslate"><span class="pre">PCA.components_</span></code> лежат вектора главных компонент, которые располагаются там построчно (n_components, n_features).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Обратите внимание, что PCA упорядочивает собственные вектора. Это значит, что собственный вектор, соответствующий главной компоненте и, соответственно, имеющей максимальную дисперсию, будет находиться в первой строке.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculating the explained variance of each of the components.</span>
<span class="n">evr</span> <span class="o">=</span> <span class="n">titanic_pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="c1"># We are plotting the explained variance ratios.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">evr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">evr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Variance by components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Теперь видим, что не только первые две компоненты дают вклад. Это происходит потому, что переменные с большим диапазоном значений не забивают остальные.</p>
<p>Правда, теперь и значимого спада в доле объясняемой дисперсии мы долго не видим, поэтому встает вопрос: как выбрать число компонент так, чтобы взять нужное и отсечь ненужное?</p>
</section>
</section>
<section id="id7">
<h3>Как выбирать оптимальное число  компонент<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<p>Скачаем датасет, на котором польза от понижения размерности видна более явно.</p>
<p>В данном датасете хранятся признаки (нам сейчас не важно, какие), характеризующие примерно 8000 клеток крови.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Reading in the scRNAseq data.</span>
<span class="n">scRNAseq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://edunet.kea.su/repo/EduNet-web_dependencies/datasets/scRNAseq_CITEseq.txt&quot;</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">x_scRNAseq</span> <span class="o">=</span> <span class="n">scRNAseq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># features</span>
<span class="n">y_scRNAseq</span> <span class="o">=</span> <span class="n">scRNAseq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># labels</span>

<span class="c1"># 2. taking the log of the data.</span>
<span class="n">x_scRNAseq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x_scRNAseq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset shape: </span><span class="si">{</span><span class="n">scRNAseq</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Подбирать число компонент можно по-разному</p>
<section id="id8">
<h4>По доле объясняемой дисперсии<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h4>
<p>Часто берут минимальное число компонент, которое объясняет 95% дисперсии. Подход, очевидно, порочный (а почему не 90% или 99%), зато быстрый.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. We&#39;re calculating the explained variance ratio for</span>
<span class="c1">#    each component of the PCA.</span>
<span class="c1"># 2. We&#39;re plotting these ratios in a chart.</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>

<span class="n">ths</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="n">total_explained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_explained</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">total_explained</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ths</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">chosen_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">total_explained</span> <span class="o">&gt;=</span> <span class="mf">0.95</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">chosen_number</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">ths</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;total sum of  proportion  of the explained variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Num of components&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Взяли 15 компонент. Почему именно столько? Почему не 16?</p>
<p>Непонятно. Просто, ибо поставили такой порог. Могли поставить и другой, и тогда бы взяли больше или меньше компонент.</p>
</section>
<section id="id9">
<h4>По правилу локтя<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h4>
<p>Можно построить график, отражающий, сколько дисперсии объясняет каждая из компонент, и на основе графика выбрать нужное число компонент.</p>
<p>Идея подхода простая: переход от компонент, объясняющих что-то важное в данных, к компонентам, объясняющим шум, должен сопровождаться резким снижением доли объясняемой дисперсии.</p>
<p>Или можно сказать иначе: выбранные нами компоненты должны быть устойчивы к добавлению шума в данные. Если мы нашли резкий скачок в доле объясняемой дисперсии, то маловероятно, что добавление шума этот скачок нивелирует — наш способ отбора компонент устойчив к шуму.</p>
<p>В идеальном случае график будет выглядеть как-то так. Но на практике таких склонов может не быть, а может быть несколько.</p>
<img src ="https://edunet.kea.su/repo/EduNet-content/L04/out/elbow_rule.png" width="600"><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. First, we create a PCA object that you fit to the training data.</span>
<span class="c1"># 2. Then, we create a a scatter plot where we plot the explained</span>
<span class="c1">#    variance ratio as a function of the number of PCA components.</span>
<span class="c1"># 3. We also plot the explained variance ratio as a function of the</span>
<span class="c1">#    number of components, but with a smooth curve.</span>
<span class="c1"># 4. Finally, we show the plot.</span>

<span class="n">n_comp</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">explained</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_comp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">explained</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_comp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">explained</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Dependence of  variance on the number of components&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Num of components&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;proportion of the explained variance&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Понять, какое число компонент стоит выбрать, из такого графика сложно. Наверно, стоит выбрать последний склон — в нашем случае мы возьмем первые 12 компонент.</p>
<p>Можно применить критерий локтя и к нашему изначальному графику с суммарной долей объясненной дисперсии (в таком случае ожидаем скачок). Но там скачок также трудно обнаружить.</p>
</section>
<section id="id10">
<h4>Перестановочный метод<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h4>
<p>Еще одним способом выбрать число главных компонент является перестановочный метод. Он заключается в следующем:</p>
<ol class="arabic simple">
<li><p>Перемешиваем значения каждого признака.</p></li>
<li><p>Получаем матрицу признаков, которая не содержит никакой информации об исходном многообразии.</p></li>
<li><p>Делаем PCA.</p></li>
<li><p>Любая explained variance — просто из-за природы данных.</p></li>
<li><p>Делаем так 100-1000 раз.</p></li>
<li><p>Пусть на реальных данных k-я компонента объясняет
n% дисперсии.</p></li>
<li><p>Смотрим на распределение доли дисперсии,
объясняемой k-компонентой для случайных данных
(полученных перемешиванием).</p></li>
<li><p>Можем сравнить и принять решение, объясняет ли k-я
компонента что-то реальное или является просто шумом.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>


<span class="k">def</span> <span class="nf">shuffle_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="n">random_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">random_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">random_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">random_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">random_data</span>


<span class="k">def</span> <span class="nf">get_variance_by_chance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">n_replics</span><span class="p">,</span> <span class="n">n_components</span><span class="p">):</span>
    <span class="n">variance_explained_by_chance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_replics</span><span class="p">,</span> <span class="n">n_components</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_replics</span><span class="p">)):</span>
        <span class="n">random_data</span> <span class="o">=</span> <span class="n">shuffle_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">random_pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
        <span class="n">random_pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">random_data</span><span class="p">)</span>
        <span class="n">variance_explained_by_chance</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">random_pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
    <span class="k">return</span> <span class="n">variance_explained_by_chance</span>


<span class="k">def</span> <span class="nf">get_pc_variance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">n_components</span><span class="p">):</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>


<span class="k">def</span> <span class="nf">plot_mean_and_CI</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">values</span><span class="p">,</span>
    <span class="n">label</span><span class="p">,</span>
    <span class="n">ci_level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">alpha_transparency</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">color_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_shading</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">se</span> <span class="o">=</span> <span class="n">std</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="n">q_alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ci_level</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ci_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">q_alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">lb</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">ci_num</span> <span class="o">*</span> <span class="n">se</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">ci_num</span> <span class="o">*</span> <span class="n">se</span>

    <span class="c1"># plot the shaded range of the confidence intervals</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ub</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_shading</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_transparency</span>
    <span class="p">)</span>
    <span class="c1"># plot the mean on top</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color_mean</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_explained_variance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">variance</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">variance</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;real&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">variance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">variance</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_variance_by_change</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">):</span>
    <span class="n">plot_mean_and_CI</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;chance&quot;</span><span class="p">,</span> <span class="n">color_mean</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">color_shading</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">calc_permutat_pval</span><span class="p">(</span><span class="n">real_values</span><span class="p">,</span> <span class="n">permut_values</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">permut_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">p_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">real_values</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">permut_values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">eps</span>
    <span class="k">return</span> <span class="n">p_values</span>


<span class="k">def</span> <span class="nf">plot_explained_vs_chance</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">explained_variance</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span>
<span class="p">):</span>
    <span class="n">plot_explained_variance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">explained_variance</span><span class="p">)</span>
    <span class="n">plot_variance_by_change</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PCA </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Component number&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Explained variance ration&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">explained_variance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">explained_variance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">explained_variance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_pval_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">,</span> <span class="n">alpha_level</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">logscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">logscale</span><span class="p">:</span>
        <span class="n">p_values</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">p_values</span><span class="p">)</span>
        <span class="n">alpha_level</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">alpha_level</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PC significance, </span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_values</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Component number&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;-log(pvalue + eps)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">step</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="n">alpha_level</span><span class="p">,</span>
        <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">xmax</span><span class="o">=</span><span class="n">p_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pca_analysis</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_replics</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">n_components</span> <span class="o">=</span> <span class="n">n_components</span> <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">explained_variance</span> <span class="o">=</span> <span class="n">get_pc_variance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">n_components</span><span class="p">)</span>
    <span class="n">variance_by_chance</span> <span class="o">=</span> <span class="n">get_variance_by_chance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">n_replics</span><span class="p">,</span> <span class="n">n_components</span><span class="p">)</span>
    <span class="n">p_values</span> <span class="o">=</span> <span class="n">calc_permutat_pval</span><span class="p">(</span><span class="n">explained_variance</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">)</span>
    <span class="n">plot_explained_vs_chance</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">explained_variance</span><span class="p">,</span> <span class="n">variance_by_chance</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">plot_pval_plot</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">p_values</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">1.7</span><span class="p">)</span>
<span class="n">pca_analysis</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_train</span><span class="p">),</span> <span class="s2">&quot;Titanic&quot;</span><span class="p">,</span> <span class="n">n_replics</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id11">
<h3>Проблемы  PCA<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h3>
<section id="id12">
<h4>Интересное направление в данных может не совпадать с направлением максимальной дисперсии.<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h4>
<p>Рассмотрим случай выборки, которая сгенерирована из двух вытянутых нормальных распределений, чьи основные оси неортогональны друг другу:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/problem_pca_2.png" width="600"/></section>
<section id="id13">
<h4>Выбранные оси могут вообще не подходить для нашей задачи<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h4>
<p>В примере ниже дисперсии не отражают интересующих нас направлений в данных:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/problem_pca_1.png" width="600"/><p>Очевидно, что в данном случае метод главных компонент будет считать вертикальную компоненту более значимой для описания набора данных, чем горизонтальную.</p>
<p>Но, например, в случае, когда данные из левого и правого кластера относятся к разным классам, для их линейной разделимости вертикальная компонента является шумовой. Несмотря на это, её метод главных компонент никогда шумовой не признает, и есть вероятность, что отбор признаков с его помощью выкинет из ваших данных значимые для решаемой вами задачи компоненты просто потому, что вдоль них значения имеют низкую дисперсию.</p>
<p>Справляться с такими ситуациями могут некоторые другие методы уменьшения размерности данных, например, метод независимых компонент (Independent Component Analysis, ICA).</p>
</section>
<section id="id14">
<h4>Недостатки линейного PCA<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h4>
<p>Как мы увидели в предыдущих примерах, обычный PCA далеко не всегда работает хорошо. В частности, могут быть ситуации, когда построенная PCA проекция не дает хорошего разбиения объектов на группы. Для набора картинок с написанными от руки цифрами  MNIST, PCA даст такой результат:</p>
<center><img src="https://edunet.kea.su/repo/EduNet-content/L04/out/pca_tsne_umap_on_mnist.png" width="1000"/></center><p>Также бывают ситуации, когда оптимально спроецировать не на некоторую плоскость, а на многообразие (кривая плоскость), как показано на картинке ниже.</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/s_manifold.png" width="650"/><p>В данном случае оптимально спроецировать на S-образную кривую.</p>
<p>В связи с вышеописанными случаями, ниже мы рассмотрим более сильные методы.</p>
</section>
</section>
</section>
<section id="kernel-pca">
<h2>Kernel PCA Ядровой (нелинейный) метод главных компонент<a class="headerlink" href="#kernel-pca" title="Permalink to this heading">#</a></h2>
<p>Как уже упоминалось, иногда невозможно захватить всю информацию линейной проекцией, хотя кривая поверхность с такой же размерностью это позволяет сделать. Одним из подходов к решению данной проблемы является задача перевода признаков в нелинейное пространство.</p>
<section id="kernel-trick">
<h3>Kernel trick<a class="headerlink" href="#kernel-trick" title="Permalink to this heading">#</a></h3>
<p>Kernel Trick избегает явного перевода наших признаков в пространство новых признаков, ведь пространства бывают очень большие, а нам бы хотелось сэкономить память компьютера.
Оказывается, для PCA не важны собственно признаки объектов, а важны скалярные произведения между объектами.</p>
<p>И это скалярное произведением позволяет подсчитывать напрямую функция <span class="math notranslate nohighlight">\(k(\mathbf {x} ,\mathbf {x'})\)</span>, которую часто называют <em>ядром или ядерной функцией (kernel, kernel function)</em></p>
<p>Бывают разные ядра, которые считают скалярное произведение в разных пространствах</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\large \displaystyle k(x_i, x_j) = \frac{1}{z} e^{-\frac{h(x_i, x_j)^2}{h}}\)</span> — радиальная базисная функция (RBF)</p></li>
<li><p><span class="math notranslate nohighlight">\(k(x_i, x_j) = (&lt;x_i, x_j&gt; + c)^d; c, d \in \mathbb{R}\)</span> — полиномиальное ядро</p></li>
<li><p><span class="math notranslate nohighlight">\(k(x_i, x_j) = \sigma((&lt;x_i, x_j&gt;)\)</span> — ядро с функцией активации</p></li>
</ul>
</section>
<section id="id15">
<h3>Пример<a class="headerlink" href="#id15" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># https://scikit-learn.org/stable/auto_examples/decomposition/plot_kernel_pca.html</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_circles</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># 1. Make_circles creates a data set of 400 points that form concentric circles with a gap of 50 points.</span>
<span class="c1"># 2. The factor parameter controls the size of the inner circles.</span>
<span class="c1"># 3. The noise parameter controls the amount of noise added to the data.</span>
<span class="c1"># 4. The result is a 360-feature dataset of concentric circles with gaps.</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_circles</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Возьмем две концентрические окружности</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original space&quot;</span><span class="p">)</span>
<span class="n">reds</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">blues</span> <span class="o">=</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$x_1$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$x_2$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Обычный PCA не может их разделить</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">x_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pca</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_pca</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_pca</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_pca</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Projection by PCA&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;1st principal component&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;2nd component&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>А вот KernelPCA  справляется</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">KernelPCA</span>

<span class="c1"># 1. Create a PCA object to perform the PCA transformation</span>
<span class="c1">#    using the RBF kernel (specified using kernel=&quot;rbf&quot;).</span>
<span class="c1">#    Setting fit_inverse_transform=True. This will make the object use the</span>
<span class="c1">#    transformed data from the first step when transforming new, unseen data points.</span>
<span class="c1"># 2. Let the PCA object fit and transform the data,</span>
<span class="c1">#    then get the transformed data back.</span>

<span class="n">kpca</span> <span class="o">=</span> <span class="n">KernelPCA</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;rbf&quot;</span><span class="p">,</span> <span class="n">fit_inverse_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">x_kpca</span> <span class="o">=</span> <span class="n">kpca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_kpca</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_kpca</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_kpca</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_kpca</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Projection by KPCA&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;1st principal component in space induced by $\phi$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;2nd component&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Хотя, конечно, и восстанавливать он будет не идеально: работал-то он по факту в пространстве бОльшей размерности и оси строил там.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. The &#39;kpca&#39; variable is a KernelPCA object that is initialized with &#39;n_components&#39; set to 2.</span>
<span class="c1"># 2. Then it applies the kernel function specified in the &#39;kernel&#39; variable  and then transforms the data based on the kernel, and gets the transformed data.</span>
<span class="c1"># 3. Then it returns the transformed data.</span>
<span class="c1"># 4. Then we get the inverse transformation by simply calling &quot;kpca.inverse_transform(x_kpca)&quot;</span>
<span class="c1"># 5. Finally, we plot the transformed data.</span>

<span class="n">x_back</span> <span class="o">=</span> <span class="n">kpca</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">x_kpca</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_back</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_back</span><span class="p">[</span><span class="n">reds</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_back</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_back</span><span class="p">[</span><span class="n">blues</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original space after inverse transform&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$x_1$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$x_2$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Kernel PCA довольно чувствителен к выбору ядра.</p>
<p>К примеру, для данных, расположенных на трех окружностях:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/kernel_pca_three_circles.png" width="260"/><p>в зависимости от выбора ядра мы будем получать совершенно разные отображение в спрямляющее пространство:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/kernel_pca_different_kernels.png" width="600"/></section>
</section>
<section id="id16">
<h2>Методы, основанные на сохранении расстояний<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h2>
<p>Существуют и другие методы понижения размерности в данных. К примеру, t-SNE и UMAP.</p>
<p>Они решают немного иначе поставленную задачу: из измерения новой размерности мы не должны легко переходить в старое измерение. Взамен этого требуется, чтобы сохранялись расстояния между объектами. Причем, особое внимание уделяется близким расстояниям. Далекие же могут не сохраняться.</p>
</section>
<section id="t-sne-t-distributed-stochastic-neighbor-embedding">
<h2>t-SNE (t-distributed stochastic neighbor embedding)<a class="headerlink" href="#t-sne-t-distributed-stochastic-neighbor-embedding" title="Permalink to this heading">#</a></h2>
<p>Идея состоит в том, чтобы не напрямую максимизировать дисперсию, а найти такое пространство, в котором расстояние между объектами будет сохраняться или по крайне мере не сильно меняться.</p>
<p>При этом будем больше беспокоиться о расстоянии между близкими объектами, нежели о расстоянии между далекими.</p>
<section id="id17">
<h3>Описываем расстояния в исходном пространстве<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h3>
<p>Для простоты будем в качестве исходного пространства рассматривать 2-мерное</p>
<ol class="arabic simple">
<li><p>Считаем все расстояния от заданной точки до остальных:</p></li>
</ol>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_compute_distance_in_source_space_step1.png" width="200"><ol class="arabic simple" start="2">
<li><p>Откладываем расстояния на прямой, предполагая, что это координаты <span class="math notranslate nohighlight">\(x\)</span> точек, лежащих на графике плотности нормального распределения. И в качестве ненормированных расстояний используем координаты <span class="math notranslate nohighlight">\(y\)</span> этих точек:</p></li>
</ol>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_compute_distance_in_source_space_step2.png" width="300"><p>Далее эти ненормированные расстояния нормируем на их сумму, чтобы для каждой точки похожести несли примерно одинаковый смысл. В итоге получается такая формула:
$<span class="math notranslate nohighlight">\(\large p_{j\mid i}={\frac {\exp(-\lVert \mathbf{x}_{i}-\mathbf {x}_{j}\rVert^{2}/2\sigma_{i}^{2})}{\sum_{k\neq i}\exp(-\lVert \mathbf{x}_{i}-\mathbf{x}_{k}\rVert^{2}/2\sigma_{i}^{2})}}\)</span>$</p>
<p>Стандартное отклонение будет различным для каждой точки. Оно подбирается бинарным поиском так, чтобы точки в областях с большей плотностью имели меньшую дисперсию. Для этого используется параметр perplexity: чем он больше, тем более далеким соседям уделяется внимание (стандартные отклонения становятся в целом больше).</p>
<p>Чтобы получить симметричные расстояния <span class="math notranslate nohighlight">\(p_{ij}\)</span>, их считают по следующей
формуле:</p>
<div class="math notranslate nohighlight">
\[p_{ij} = \frac{p_{j\mid i} + p_{i\mid j}}{2N}\]</div>
<p>В итоге получаем матрицу расстояний следующего вида:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_get_distance_matrix.png" width="650"/></section>
<section id="id18">
<h3>Описываем расстояния в пространстве низкой размерности<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h3>
<p>Обычно в случае t-SNE используют пространства двумерные и трехмерные. Это вызвано во многом скоростью работы метода и тем, что он преимущественно используется для визуализации.</p>
<p>Для простоты будем в качестве пространства низкой размерности рассматривать одномерное.</p>
<p>Расположим точки, соответствующие точкам из исходного пространства, случайным образом в одномерном пространстве.</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_points_in_one_dimensional_space.png" width="350"/><p>Точно так же будем считать расстояние между выбранной точкой и остальными и использовать эти расстояния не в качестве <span class="math notranslate nohighlight">\(x\)</span>, а в качестве <span class="math notranslate nohighlight">\(y\)</span>, и, как следствие, similarity, будем использовать не нормальное распределение, а распределение Стьюдента.</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_compute_similarity.png" width="350"/><p>Почему?
Оно более “тяжелое” в хвостах и поэтому дает возможность больше внимания уделять далеким точкам. Это позволяет компенсировать дисбаланс в распределении расстояний в пространстве большей и меньшей размерностей. Без этого точки у нас будут “липнуть” друг к другу.</p>
<p>В итоге мы получили две матрицы расстояний: в исходном и в новом пространстве:</p>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_two_matrix_distance.png" width="600"/></section>
<section id="id19">
<h3>Оптимизируем низкоразмерное представление<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h3>
<p>Они абсолютно друг на друга не похожи, что логично: пока что наша проекция в новое пространство абсолютно случайная. Надо как-то править представление в новом пространстве. Именно для этого авторы и использовали плотности и прочее — чтобы задать теперь хорошую cost-функцию, которую затем нужно минимизировать.</p>
<p>Cost-функцией будет
$<span class="math notranslate nohighlight">\(Cost = KL(P||Q) = \sum_{i \neq j}{p_{ij} log \frac{p_{ij}}{q_{ij}}}\)</span>$</p>
<p>Минимизируем это градиентным спуском.</p>
<p>Фактически, такое требование минимизировать cost-функцию говорит следующее: я хочу получить такое представление, чтобы объекты, которые находились в исходном пространстве близко, <strong>вероятно</strong>, находились и в представлении близко, а объекты, которые находились далеко — далеко.</p>
</section>
<section id="id20">
<h3>Пример применения<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h3>
<p>Для того, чтобы t-SNE сходился лучше и определеннее, в качестве изначальных координат точек в новом пространстве можно использовать не случайный шум, а первые две компоненты PCA.</p>
<p>Преследуем две цели: уменьшить время работы t-SNE (который работает очень медленно) и убрать эффект шума на t-SNE — он может на него реагировать, особенно при условии, что схождения к минимуму мы можем не дождаться.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sklearn.manifold</span>

<span class="c1"># 1. Firstly we reduce the dimensionality of the data to 6 features using PCA.</span>
<span class="c1"># 2. Then we take the first two PCA components and use this</span>
<span class="c1">#    as an initial approximation for the T-SNE algorithm.</span>
<span class="c1"># 3. Then we fit T-SNE on the data and plot the first two dimensions</span>
<span class="c1">#    of the T-SNE output, which are represented in green.</span>
<span class="c1"># 4. The visualization makes clear that there are distinct clusters in our data</span>

<span class="n">x_reduced</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_scRNAseq</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">manifold</span><span class="o">.</span><span class="n">TSNE</span><span class="p">(</span>
    <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">init</span><span class="o">=</span><span class="n">x_reduced</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># often use as a reasonable approximation</span>
    <span class="n">perplexity</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>  <span class="c1"># important parameter</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">manifold</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x_reduced</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">manifold</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">manifold</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_scRNAseq</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;tab20&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;TSNE: scRNAseq&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;TSNE1&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TSNE2&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>И покрасим по разметке, которая нам известна из эксперимента. Видим, что разделение очень хорошее</p>
</section>
<section id="t-sne">
<h3>Важные параметры t-SNE<a class="headerlink" href="#t-sne" title="Permalink to this heading">#</a></h3>
<section id="perplexity">
<h4>perplexity<a class="headerlink" href="#perplexity" title="Permalink to this heading">#</a></h4>
<p>Определяет то, как подбирается стандартное отклонение для распределения расстояний для каждой точки. Чем больше <strong>perplexity</strong>, тем более глобально мы смотрим на структуру.</p>
</section>
<section id="metric">
<h4>metric<a class="headerlink" href="#metric" title="Permalink to this heading">#</a></h4>
<p>Как считаются расстояния между точками — <strong>metric</strong>. По умолчанию используется евклидово расстояние, но часто помогают и другие (например, косинусное).</p>
</section>
<section id="learning-rate">
<h4>learning_rate<a class="headerlink" href="#learning-rate" title="Permalink to this heading">#</a></h4>
<p>Шаг градиентного спуска, тоже влияет на полученное представление.</p>
</section>
</section>
<section id="id21">
<h3>Проблемы t-SNE<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h3>
<p>Чтобы продемонстрировать проблемы t-SNE, берем оригинальные данные в 2D пространстве и добавляем к ним новые признаки, взятые из нормального шума.
Далее пытаемся восстановить изначальную структуру.</p>
<section id="id22">
<h4>Стохастичность<a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h4>
<p>Низкоразмерное представление, которое вы получите, будет отличаться между запусками, если не зафиксировать <strong>random seed</strong>. Может отличаться довольно сильно.</p>
</section>
<section id="id23">
<h4>Добавление новых точек<a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h4>
<p>Если у вас появились новые данные, то добавить их на  представление, полученное при помощи t-SNE ранее — нетривиальная задача.
Для разных областей есть свои “подгоны”, но все это эвристика.</p>
</section>
<section id="id24">
<h4>Расстояния между кластерами точек могут ничего не значить (плохо сохраняются далекие расстояния)<a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h4>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_problems_distances_between_clusters_no_matter.png" width="1000"/></section>
<section id="id25">
<h4>Размеры кластеров ничего не значат<a class="headerlink" href="#id25" title="Permalink to this heading">#</a></h4>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_problems_cluster_size_no_matter.png" width="1000"/></section>
<section id="id26">
<h4>Можно увидеть артефактные кластеры<a class="headerlink" href="#id26" title="Permalink to this heading">#</a></h4>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_problems_artifact_clusters.png" width="1000"/></section>
<section id="id27">
<h4>Можно увидеть не ту структуру, которая по идее должна быть<a class="headerlink" href="#id27" title="Permalink to this heading">#</a></h4>
<img src="https://edunet.kea.su/repo/EduNet-content/L04/out/tsne_problems_erroneous_structure.png" width="1000"/><p><a class="reference external" href="https://distill.pub/2016/misread-tsne/">Подробнее</a></p>
</section>
<section id="id28">
<h4>Использование для кластеризации<a class="headerlink" href="#id28" title="Permalink to this heading">#</a></h4>
<p>Из-за указанных  недостатков результат t-SNE НЕЛЬЗЯ использовать для кластеризации.</p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=NEaUSP4YerM">Хорошее видео про t-SNE</a></p>
<p><a class="reference external" href="https://www.nature.com/articles/s41467-019-13056-x">Статья по применению t-SNE в биологии</a></p>
</section>
</section>
</section>
<section id="umap">
<h2>UMAP<a class="headerlink" href="#umap" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://umap-learn.readthedocs.io/en/latest/how_umap_works.html">UMAP</a> — uniform manifold approximation and projection. <a class="reference external" href="https://www.youtube.com/watch?v=94ZMJ8tq1Wk">Видео</a></p>
<p><a class="reference external" href="https://pair-code.github.io/understanding-umap/">Красивая демонстрация</a></p>
<p>Использует похожую на t-SNE идею, но иначе, в результате чего получает много выгодных бонусов.</p>
<p>Внутри себя метод строит граф, в котором ребрами соединены между собой k ближайших соседей. При этом эти ребра неравноправны: если для данной пары точек расстояние между ними сильно больше, чем расстояния между ними и другими точками, то и ребро будет иметь маленький вес.</p>
<img src ="https://edunet.kea.su/repo/EduNet-content/L04/out/umap.png" width="800"><p>Далее задача состоит в том, чтобы в пространстве более низкой размерности получился граф, похожий на тот, который был в пространстве высокой размерности.
Для этого оптимизируем низкоразмерное представление градиентным спуском.</p>
<p>Явно видим, что, согласно этому подходу, надо взять 6 компонент.</p>
<section id="umap-iris">
<h3>UMAP - пример использования на датасете IRIS<a class="headerlink" href="#umap-iris" title="Permalink to this heading">#</a></h3>
<p>Загрузите <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/iris">Iris Data Set</a></p>
<p>Удобный способ сделать это использовать модуль <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_iris.html#sklearn.datasets.load_iris">sklearn.datasets</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># Download dataset</span>
<span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>И <code class="docutils literal notranslate"><span class="pre">data</span></code>, и <code class="docutils literal notranslate"><span class="pre">labels</span></code> - это N-мерные массивы. <strong>Посмотрите какие у них размеры</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((150, 4), (150,))
</pre></div>
</div>
</div>
</div>
<p>Видим, что массив <code class="docutils literal notranslate"><span class="pre">data</span></code> состоит из нескольких колонок. Такие колонки мы называем <em>features</em>. Набор данных по ирисам содержит четыре характеристики (длина чашелистиков, ширина чашелистиков, длина лепестков, ширина лепестков) 50 образцов трех видов ирисов (setosa, virginica и  versicolor). Вид ирисов отражен в массиве <code class="docutils literal notranslate"><span class="pre">labels</span></code>.</p>
<p><strong>Отфильтруйте массив <code class="docutils literal notranslate"><span class="pre">data</span></code> таким образом, что бы он содержал в себе только ирисы из класса <code class="docutils literal notranslate"><span class="pre">0</span></code></strong>. Для этого используйте конструкцию <code class="docutils literal notranslate"><span class="pre">labels</span> <span class="pre">==</span> <span class="pre">class</span></code> в качестве индекса для <code class="docutils literal notranslate"><span class="pre">data</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">data_1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">data_2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">data_0</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50, 4)
</pre></div>
</div>
</div>
</div>
<p>К сожалению, когда данных много, просто смотреть на цифры крайне не информативно.</p>
<p>Для визуализации данных в этом курсе мы будем использовать библиотеку <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>. <strong>Давайте ее импортируем</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Постройте на одном рисунке график</strong> признака с <strong>индексом 0</strong> (sepal length in cm) для каждого из <strong>3 классов</strong> (3 графика на одном рисунке). Для построения графика используйте функцию <code class="docutils literal notranslate"><span class="pre">plt.plot()</span></code>. Для того что бы получить доступ ко всем объектам в позиции 0 используйте index notation <code class="docutils literal notranslate"><span class="pre">[:,</span> <span class="pre">0]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d1ffe4b61714bf42bddbdf2baa63551fb62d8df97c0d6bef202a89d5fb61dddc.png" src="../../_images/d1ffe4b61714bf42bddbdf2baa63551fb62d8df97c0d6bef202a89d5fb61dddc.png" />
</div>
</div>
<p>В <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code> есть понятие <code class="docutils literal notranslate"><span class="pre">subplots</span></code>. Давайте создадим 3 <code class="docutils literal notranslate"><span class="pre">subplots</span></code> для наших классов</p>
<p>Если мы посмотрим на <code class="docutils literal notranslate"><span class="pre">ax.shape</span></code> - мы обнаружим что это просто массив, который содержит в себе графические объекты. Соответственно к каждому из этих <code class="docutils literal notranslate"><span class="pre">subplots</span></code> мы можем обращаться по индексу</p>
<p><strong>Для каждого класса постройте зависимость ширины от длины чашелистиков</strong>. Используйте <code class="docutils literal notranslate"><span class="pre">ax.scatter()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">length0</span> <span class="p">,</span> <span class="n">width0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_0</span><span class="p">))]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_0</span><span class="p">))])</span>
<span class="n">length1</span> <span class="p">,</span> <span class="n">width1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_1</span><span class="p">))]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_1</span><span class="p">))])</span>
<span class="n">length2</span> <span class="p">,</span> <span class="n">width2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_2</span><span class="p">))]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data_2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_2</span><span class="p">))])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">length0</span> <span class="p">,</span> <span class="n">width0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span> <span class="c1"># Your code here </span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">length1</span> <span class="p">,</span> <span class="n">width1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span> <span class="c1"># Your code here </span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">length2</span> <span class="p">,</span> <span class="n">width2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span> <span class="c1"># Your code here </span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4674dcc96688ef04f165132667c8086699455bbcb77123ce34fbb42b80286d97.png" src="../../_images/4674dcc96688ef04f165132667c8086699455bbcb77123ce34fbb42b80286d97.png" />
</div>
</div>
<p>Визуализируйте данные из iris dataset при помощи UMAP.</p>
<p>Каждый объект в датасете Iris содержит 4 признака и  него можно было посмотреть как на точку в 4-мерном пространстве, если бы мы могли такое пространство визуализировать непосредственно. В одной из будущих лекций мы подробно познакомимся с различными методами понижения размерности пространства признаков, а пока посмотрим как один таких методов — <a class="reference external" href="https://umap-learn.readthedocs.io/en/latest/index.html">UMAP</a> — можно использовать для получения двумерной аппроксимации пространства признаков датасета Iris:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> pip install umap-learn<span class="o">[</span>plot<span class="o">]</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="n">clear_output</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">umap</span>
<span class="kn">import</span> <span class="nn">umap.plot</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<p>Рассмотрим двумерную проекцию данных при помощи UMAP:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mapper</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">annotation_on_plot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
                                   <span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
                                   <span class="s1">&#39;sepal length in cm&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                                   <span class="s1">&#39;sepal width in cm&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                   <span class="s1">&#39;petal length in cm&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                                   <span class="s1">&#39;petal width in cm&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
                                   <span class="p">})</span>

<span class="n">annotation_on_plot</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation_on_plot</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span><span class="s1">&#39;Setosa&#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span><span class="s1">&#39;Versicolor&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span><span class="s1">&#39;Virginica&#39;</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">umap</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">output_notebook</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                          <span class="n">hover_data</span><span class="o">=</span><span class="n">annotation_on_plot</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">umap</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="bk-root">
        <a href="https://bokeh.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
        <span id="1002">Loading BokehJS ...</span>
    </div>
</div><script type="application/javascript">(function(root) {
  function now() {
    return new Date();
  }

  const force = true;

  if (typeof root._bokeh_onload_callbacks === "undefined" || force === true) {
    root._bokeh_onload_callbacks = [];
    root._bokeh_is_loading = undefined;
  }

const JS_MIME_TYPE = 'application/javascript';
  const HTML_MIME_TYPE = 'text/html';
  const EXEC_MIME_TYPE = 'application/vnd.bokehjs_exec.v0+json';
  const CLASS_NAME = 'output_bokeh rendered_html';

  /**
   * Render data to the DOM node
   */
  function render(props, node) {
    const script = document.createElement("script");
    node.appendChild(script);
  }

  /**
   * Handle when an output is cleared or removed
   */
  function handleClearOutput(event, handle) {
    const cell = handle.cell;

    const id = cell.output_area._bokeh_element_id;
    const server_id = cell.output_area._bokeh_server_id;
    // Clean up Bokeh references
    if (id != null && id in Bokeh.index) {
      Bokeh.index[id].model.document.clear();
      delete Bokeh.index[id];
    }

    if (server_id !== undefined) {
      // Clean up Bokeh references
      const cmd_clean = "from bokeh.io.state import curstate; print(curstate().uuid_to_server['" + server_id + "'].get_sessions()[0].document.roots[0]._id)";
      cell.notebook.kernel.execute(cmd_clean, {
        iopub: {
          output: function(msg) {
            const id = msg.content.text.trim();
            if (id in Bokeh.index) {
              Bokeh.index[id].model.document.clear();
              delete Bokeh.index[id];
            }
          }
        }
      });
      // Destroy server and session
      const cmd_destroy = "import bokeh.io.notebook as ion; ion.destroy_server('" + server_id + "')";
      cell.notebook.kernel.execute(cmd_destroy);
    }
  }

  /**
   * Handle when a new output is added
   */
  function handleAddOutput(event, handle) {
    const output_area = handle.output_area;
    const output = handle.output;

    // limit handleAddOutput to display_data with EXEC_MIME_TYPE content only
    if ((output.output_type != "display_data") || (!Object.prototype.hasOwnProperty.call(output.data, EXEC_MIME_TYPE))) {
      return
    }

    const toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);

    if (output.metadata[EXEC_MIME_TYPE]["id"] !== undefined) {
      toinsert[toinsert.length - 1].firstChild.textContent = output.data[JS_MIME_TYPE];
      // store reference to embed id on output_area
      output_area._bokeh_element_id = output.metadata[EXEC_MIME_TYPE]["id"];
    }
    if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
      const bk_div = document.createElement("div");
      bk_div.innerHTML = output.data[HTML_MIME_TYPE];
      const script_attrs = bk_div.children[0].attributes;
      for (let i = 0; i < script_attrs.length; i++) {
        toinsert[toinsert.length - 1].firstChild.setAttribute(script_attrs[i].name, script_attrs[i].value);
        toinsert[toinsert.length - 1].firstChild.textContent = bk_div.children[0].textContent
      }
      // store reference to server id on output_area
      output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
    }
  }

  function register_renderer(events, OutputArea) {

    function append_mime(data, metadata, element) {
      // create a DOM node to render to
      const toinsert = this.create_output_subarea(
        metadata,
        CLASS_NAME,
        EXEC_MIME_TYPE
      );
      this.keyboard_manager.register_events(toinsert);
      // Render to node
      const props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
      render(props, toinsert[toinsert.length - 1]);
      element.append(toinsert);
      return toinsert
    }

    /* Handle when an output is cleared or removed */
    events.on('clear_output.CodeCell', handleClearOutput);
    events.on('delete.Cell', handleClearOutput);

    /* Handle when a new output is added */
    events.on('output_added.OutputArea', handleAddOutput);

    /**
     * Register the mime type and append_mime function with output_area
     */
    OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
      /* Is output safe? */
      safe: true,
      /* Index of renderer in `output_area.display_order` */
      index: 0
    });
  }

  // register the mime type if in Jupyter Notebook environment and previously unregistered
  if (root.Jupyter !== undefined) {
    const events = require('base/js/events');
    const OutputArea = require('notebook/js/outputarea').OutputArea;

    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  }
  if (typeof (root._bokeh_timeout) === "undefined" || force === true) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  const NB_LOAD_WARNING = {'data': {'text/html':
     "<div style='background-color: #fdd'>\n"+
     "<p>\n"+
     "BokehJS does not appear to have successfully loaded. If loading BokehJS from CDN, this \n"+
     "may be due to a slow or bad network connection. Possible fixes:\n"+
     "</p>\n"+
     "<ul>\n"+
     "<li>re-rerun `output_notebook()` to attempt to load from CDN again, or</li>\n"+
     "<li>use INLINE resources instead, as so:</li>\n"+
     "</ul>\n"+
     "<code>\n"+
     "from bokeh.resources import INLINE\n"+
     "output_notebook(resources=INLINE)\n"+
     "</code>\n"+
     "</div>"}};

  function display_loaded() {
    const el = document.getElementById("1002");
    if (el != null) {
      el.textContent = "BokehJS is loading...";
    }
    if (root.Bokeh !== undefined) {
      if (el != null) {
        el.textContent = "BokehJS " + root.Bokeh.version + " successfully loaded.";
      }
    } else if (Date.now() < root._bokeh_timeout) {
      setTimeout(display_loaded, 100)
    }
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];

    root._bokeh_onload_callbacks.push(callback);
    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls == null || js_urls.length === 0) {
      run_callbacks();
      return null;
    }
    console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    root._bokeh_is_loading = css_urls.length + js_urls.length;

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }

    function on_error(url) {
      console.error("failed to load " + url);
    }

    for (let i = 0; i < css_urls.length; i++) {
      const url = css_urls[i];
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }

    for (let i = 0; i < js_urls.length; i++) {
      const url = js_urls[i];
      const element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error.bind(null, url);
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  const js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-2.4.3.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-2.4.3.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-2.4.3.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-2.4.3.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-mathjax-2.4.3.min.js", "https://unpkg.com/@holoviz/panel@0.14.3/dist/panel.min.js"];
  const css_urls = [];

  const inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {
    }
  ];

  function run_inline_js() {
    if (root.Bokeh !== undefined || force === true) {
          for (let i = 0; i < inline_js.length; i++) {
      inline_js[i].call(root, root.Bokeh);
    }
if (force === true) {
        display_loaded();
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    } else if (force !== true) {
      const cell = $(document.getElementById("1002")).parents('.cell').data().cell;
      cell.output_area.append_execute_result(NB_LOAD_WARNING)
    }
  }

  if (root._bokeh_is_loading === 0) {
    console.debug("Bokeh: BokehJS loaded, going straight to plotting");
    run_inline_js();
  } else {
    load_libs(css_urls, js_urls, function() {
      console.debug("Bokeh: BokehJS plotting callback run at", now());
      run_inline_js();
    });
  }
}(window));</script><div class="output text_html">
  <div class="bk-root" id="46f488ba-6a79-4f60-850a-f9e852d893e7" data-root-id="1004"></div>
</div><script type="application/javascript">(function(root) {
  function embed_document(root) {
  const docs_json = {"0d082026-3fc7-4b58-bd70-e25a8cd6beff":{"defs":[{"extends":null,"module":null,"name":"ReactiveHTML1","overrides":[],"properties":[]},{"extends":null,"module":null,"name":"FlexBox1","overrides":[],"properties":[{"default":"flex-start","kind":null,"name":"align_content"},{"default":"flex-start","kind":null,"name":"align_items"},{"default":"row","kind":null,"name":"flex_direction"},{"default":"wrap","kind":null,"name":"flex_wrap"},{"default":"flex-start","kind":null,"name":"justify_content"}]},{"extends":null,"module":null,"name":"GridStack1","overrides":[],"properties":[{"default":"warn","kind":null,"name":"mode"},{"default":null,"kind":null,"name":"ncols"},{"default":null,"kind":null,"name":"nrows"},{"default":true,"kind":null,"name":"allow_resize"},{"default":true,"kind":null,"name":"allow_drag"},{"default":[],"kind":null,"name":"state"}]},{"extends":null,"module":null,"name":"click1","overrides":[],"properties":[{"default":"","kind":null,"name":"terminal_output"},{"default":"","kind":null,"name":"debug_name"},{"default":0,"kind":null,"name":"clears"}]},{"extends":null,"module":null,"name":"NotificationAreaBase1","overrides":[],"properties":[{"default":"bottom-right","kind":null,"name":"position"},{"default":0,"kind":null,"name":"_clear"}]},{"extends":null,"module":null,"name":"NotificationArea1","overrides":[],"properties":[{"default":[],"kind":null,"name":"notifications"},{"default":"bottom-right","kind":null,"name":"position"},{"default":0,"kind":null,"name":"_clear"},{"default":[{"background":"#ffc107","icon":{"className":"fas fa-exclamation-triangle","color":"white","tagName":"i"},"type":"warning"},{"background":"#007bff","icon":{"className":"fas fa-info-circle","color":"white","tagName":"i"},"type":"info"}],"kind":null,"name":"types"}]},{"extends":null,"module":null,"name":"Notification","overrides":[],"properties":[{"default":null,"kind":null,"name":"background"},{"default":3000,"kind":null,"name":"duration"},{"default":null,"kind":null,"name":"icon"},{"default":"","kind":null,"name":"message"},{"default":null,"kind":null,"name":"notification_type"},{"default":false,"kind":null,"name":"_destroyed"}]},{"extends":null,"module":null,"name":"TemplateActions1","overrides":[],"properties":[{"default":0,"kind":null,"name":"open_modal"},{"default":0,"kind":null,"name":"close_modal"}]},{"extends":null,"module":null,"name":"MaterialTemplateActions1","overrides":[],"properties":[{"default":0,"kind":null,"name":"open_modal"},{"default":0,"kind":null,"name":"close_modal"}]}],"roots":{"references":[{"attributes":{"background_fill_color":"white","below":[{"id":"1013"}],"center":[{"id":"1016"},{"id":"1020"}],"height":800,"left":[{"id":"1017"}],"renderers":[{"id":"1041"}],"title":{"id":"1043"},"toolbar":{"id":"1029"},"width":800,"x_range":{"id":"1005"},"x_scale":{"id":"1009"},"y_range":{"id":"1007"},"y_scale":{"id":"1011"}},"id":"1004","subtype":"Figure","type":"Plot"},{"attributes":{},"id":"1050","type":"AllLabels"},{"attributes":{"data":{"alpha":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],"color":["#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#393b79","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#e7ba52","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6","#de9ed6"],"index":{"__ndarray__":"AAAAAAEAAAACAAAAAwAAAAQAAAAFAAAABgAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAAAARAAAAEgAAABMAAAAUAAAAFQAAABYAAAAXAAAAGAAAABkAAAAaAAAAGwAAABwAAAAdAAAAHgAAAB8AAAAgAAAAIQAAACIAAAAjAAAAJAAAACUAAAAmAAAAJwAAACgAAAApAAAAKgAAACsAAAAsAAAALQAAAC4AAAAvAAAAMAAAADEAAAAyAAAAMwAAADQAAAA1AAAANgAAADcAAAA4AAAAOQAAADoAAAA7AAAAPAAAAD0AAAA+AAAAPwAAAEAAAABBAAAAQgAAAEMAAABEAAAARQAAAEYAAABHAAAASAAAAEkAAABKAAAASwAAAEwAAABNAAAATgAAAE8AAABQAAAAUQAAAFIAAABTAAAAVAAAAFUAAABWAAAAVwAAAFgAAABZAAAAWgAAAFsAAABcAAAAXQAAAF4AAABfAAAAYAAAAGEAAABiAAAAYwAAAGQAAABlAAAAZgAAAGcAAABoAAAAaQAAAGoAAABrAAAAbAAAAG0AAABuAAAAbwAAAHAAAABxAAAAcgAAAHMAAAB0AAAAdQAAAHYAAAB3AAAAeAAAAHkAAAB6AAAAewAAAHwAAAB9AAAAfgAAAH8AAACAAAAAgQAAAIIAAACDAAAAhAAAAIUAAACGAAAAhwAAAIgAAACJAAAAigAAAIsAAACMAAAAjQAAAI4AAACPAAAAkAAAAJEAAACSAAAAkwAAAJQAAACVAAAA","dtype":"int32","order":"little","shape":[150]},"item":["Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Setosa","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Versicolor","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica","Virginica"],"label":{"__ndarray__":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAA","dtype":"int32","order":"little","shape":[150]},"level_0":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149],"petal length in cm":{"__ndarray__":"ZmZmZmZm9j9mZmZmZmb2P83MzMzMzPQ/AAAAAAAA+D9mZmZmZmb2PzMzMzMzM/s/ZmZmZmZm9j8AAAAAAAD4P2ZmZmZmZvY/AAAAAAAA+D8AAAAAAAD4P5qZmZmZmfk/ZmZmZmZm9j+amZmZmZnxPzMzMzMzM/M/AAAAAAAA+D/NzMzMzMz0P2ZmZmZmZvY/MzMzMzMz+z8AAAAAAAD4PzMzMzMzM/s/AAAAAAAA+D8AAAAAAADwPzMzMzMzM/s/ZmZmZmZm/j+amZmZmZn5P5qZmZmZmfk/AAAAAAAA+D9mZmZmZmb2P5qZmZmZmfk/mpmZmZmZ+T8AAAAAAAD4PwAAAAAAAPg/ZmZmZmZm9j8AAAAAAAD4PzMzMzMzM/M/zczMzMzM9D9mZmZmZmb2P83MzMzMzPQ/AAAAAAAA+D/NzMzMzMz0P83MzMzMzPQ/zczMzMzM9D+amZmZmZn5P2ZmZmZmZv4/ZmZmZmZm9j+amZmZmZn5P2ZmZmZmZvY/AAAAAAAA+D9mZmZmZmb2P83MzMzMzBJAAAAAAAAAEkCamZmZmZkTQAAAAAAAABBAZmZmZmZmEkAAAAAAAAASQM3MzMzMzBJAZmZmZmZmCkBmZmZmZmYSQDMzMzMzMw9AAAAAAAAADEDNzMzMzMwQQAAAAAAAABBAzczMzMzMEkDNzMzMzMwMQJqZmZmZmRFAAAAAAAAAEkBmZmZmZmYQQAAAAAAAABJAMzMzMzMzD0AzMzMzMzMTQAAAAAAAABBAmpmZmZmZE0DNzMzMzMwSQDMzMzMzMxFAmpmZmZmZEUAzMzMzMzMTQAAAAAAAABRAAAAAAAAAEkAAAAAAAAAMQGZmZmZmZg5AmpmZmZmZDUAzMzMzMzMPQGZmZmZmZhRAAAAAAAAAEkAAAAAAAAASQM3MzMzMzBJAmpmZmZmZEUBmZmZmZmYQQAAAAAAAABBAmpmZmZmZEUBmZmZmZmYSQAAAAAAAABBAZmZmZmZmCkDNzMzMzMwQQM3MzMzMzBBAzczMzMzMEEAzMzMzMzMRQAAAAAAAAAhAZmZmZmZmEEAAAAAAAAAYQGZmZmZmZhRAmpmZmZmZF0BmZmZmZmYWQDMzMzMzMxdAZmZmZmZmGkAAAAAAAAASQDMzMzMzMxlAMzMzMzMzF0BmZmZmZmYYQGZmZmZmZhRAMzMzMzMzFUAAAAAAAAAWQAAAAAAAABRAZmZmZmZmFEAzMzMzMzMVQAAAAAAAABZAzczMzMzMGkCamZmZmZkbQAAAAAAAABRAzczMzMzMFkCamZmZmZkTQM3MzMzMzBpAmpmZmZmZE0DNzMzMzMwWQAAAAAAAABhAMzMzMzMzE0CamZmZmZkTQGZmZmZmZhZAMzMzMzMzF0BmZmZmZmYYQJqZmZmZmRlAZmZmZmZmFkBmZmZmZmYUQGZmZmZmZhZAZmZmZmZmGEBmZmZmZmYWQAAAAAAAABZAMzMzMzMzE0CamZmZmZkVQGZmZmZmZhZAZmZmZmZmFEBmZmZmZmYUQJqZmZmZmRdAzczMzMzMFkDNzMzMzMwUQAAAAAAAABRAzczMzMzMFECamZmZmZkVQGZmZmZmZhRA","dtype":"float64","order":"little","shape":[150]},"petal width in cm":{"__ndarray__":"mpmZmZmZyT+amZmZmZnJP5qZmZmZmck/mpmZmZmZyT+amZmZmZnJP5qZmZmZmdk/MzMzMzMz0z+amZmZmZnJP5qZmZmZmck/mpmZmZmZuT+amZmZmZnJP5qZmZmZmck/mpmZmZmZuT+amZmZmZm5P5qZmZmZmck/mpmZmZmZ2T+amZmZmZnZPzMzMzMzM9M/MzMzMzMz0z8zMzMzMzPTP5qZmZmZmck/mpmZmZmZ2T+amZmZmZnJPwAAAAAAAOA/mpmZmZmZyT+amZmZmZnJP5qZmZmZmdk/mpmZmZmZyT+amZmZmZnJP5qZmZmZmck/mpmZmZmZyT+amZmZmZnZP5qZmZmZmbk/mpmZmZmZyT+amZmZmZnJP5qZmZmZmck/mpmZmZmZyT+amZmZmZm5P5qZmZmZmck/mpmZmZmZyT8zMzMzMzPTPzMzMzMzM9M/mpmZmZmZyT8zMzMzMzPjP5qZmZmZmdk/MzMzMzMz0z+amZmZmZnJP5qZmZmZmck/mpmZmZmZyT+amZmZmZnJP2ZmZmZmZvY/AAAAAAAA+D8AAAAAAAD4P83MzMzMzPQ/AAAAAAAA+D/NzMzMzMz0P5qZmZmZmfk/AAAAAAAA8D/NzMzMzMz0P2ZmZmZmZvY/AAAAAAAA8D8AAAAAAAD4PwAAAAAAAPA/ZmZmZmZm9j/NzMzMzMz0P2ZmZmZmZvY/AAAAAAAA+D8AAAAAAADwPwAAAAAAAPg/mpmZmZmZ8T/NzMzMzMz8P83MzMzMzPQ/AAAAAAAA+D8zMzMzMzPzP83MzMzMzPQ/ZmZmZmZm9j9mZmZmZmb2PzMzMzMzM/s/AAAAAAAA+D8AAAAAAADwP5qZmZmZmfE/AAAAAAAA8D8zMzMzMzPzP5qZmZmZmfk/AAAAAAAA+D+amZmZmZn5PwAAAAAAAPg/zczMzMzM9D/NzMzMzMz0P83MzMzMzPQ/MzMzMzMz8z9mZmZmZmb2PzMzMzMzM/M/AAAAAAAA8D/NzMzMzMz0PzMzMzMzM/M/zczMzMzM9D/NzMzMzMz0P5qZmZmZmfE/zczMzMzM9D8AAAAAAAAEQGZmZmZmZv4/zczMzMzMAEDNzMzMzMz8P5qZmZmZmQFAzczMzMzMAEAzMzMzMzP7P83MzMzMzPw/zczMzMzM/D8AAAAAAAAEQAAAAAAAAABAZmZmZmZm/j/NzMzMzMwAQAAAAAAAAABAMzMzMzMzA0BmZmZmZmYCQM3MzMzMzPw/mpmZmZmZAUBmZmZmZmYCQAAAAAAAAPg/ZmZmZmZmAkAAAAAAAAAAQAAAAAAAAABAzczMzMzM/D/NzMzMzMwAQM3MzMzMzPw/zczMzMzM/D/NzMzMzMz8P83MzMzMzABAmpmZmZmZ+T9mZmZmZmb+PwAAAAAAAABAmpmZmZmZAUAAAAAAAAD4P2ZmZmZmZvY/ZmZmZmZmAkAzMzMzMzMDQM3MzMzMzPw/zczMzMzM/D/NzMzMzMwAQDMzMzMzMwNAZmZmZmZmAkBmZmZmZmb+P2ZmZmZmZgJAAAAAAAAABEBmZmZmZmYCQGZmZmZmZv4/AAAAAAAAAEBmZmZmZmYCQM3MzMzMzPw/","dtype":"float64","order":"little","shape":[150]},"sepal length in cm":{"__ndarray__":"ZmZmZmZmFECamZmZmZkTQM3MzMzMzBJAZmZmZmZmEkAAAAAAAAAUQJqZmZmZmRVAZmZmZmZmEkAAAAAAAAAUQJqZmZmZmRFAmpmZmZmZE0CamZmZmZkVQDMzMzMzMxNAMzMzMzMzE0AzMzMzMzMRQDMzMzMzMxdAzczMzMzMFkCamZmZmZkVQGZmZmZmZhRAzczMzMzMFkBmZmZmZmYUQJqZmZmZmRVAZmZmZmZmFEBmZmZmZmYSQGZmZmZmZhRAMzMzMzMzE0AAAAAAAAAUQAAAAAAAABRAzczMzMzMFEDNzMzMzMwUQM3MzMzMzBJAMzMzMzMzE0CamZmZmZkVQM3MzMzMzBRAAAAAAAAAFkCamZmZmZkTQAAAAAAAABRAAAAAAAAAFkCamZmZmZkTQJqZmZmZmRFAZmZmZmZmFEAAAAAAAAAUQAAAAAAAABJAmpmZmZmZEUAAAAAAAAAUQGZmZmZmZhRAMzMzMzMzE0BmZmZmZmYUQGZmZmZmZhJAMzMzMzMzFUAAAAAAAAAUQAAAAAAAABxAmpmZmZmZGUCamZmZmZkbQAAAAAAAABZAAAAAAAAAGkDNzMzMzMwWQDMzMzMzMxlAmpmZmZmZE0BmZmZmZmYaQM3MzMzMzBRAAAAAAAAAFECamZmZmZkXQAAAAAAAABhAZmZmZmZmGEBmZmZmZmYWQM3MzMzMzBpAZmZmZmZmFkAzMzMzMzMXQM3MzMzMzBhAZmZmZmZmFkCamZmZmZkXQGZmZmZmZhhAMzMzMzMzGUBmZmZmZmYYQJqZmZmZmRlAZmZmZmZmGkAzMzMzMzMbQM3MzMzMzBpAAAAAAAAAGEDNzMzMzMwWQAAAAAAAABZAAAAAAAAAFkAzMzMzMzMXQAAAAAAAABhAmpmZmZmZFUAAAAAAAAAYQM3MzMzMzBpAMzMzMzMzGUBmZmZmZmYWQAAAAAAAABZAAAAAAAAAFkBmZmZmZmYYQDMzMzMzMxdAAAAAAAAAFEBmZmZmZmYWQM3MzMzMzBZAzczMzMzMFkDNzMzMzMwYQGZmZmZmZhRAzczMzMzMFkAzMzMzMzMZQDMzMzMzMxdAZmZmZmZmHEAzMzMzMzMZQAAAAAAAABpAZmZmZmZmHkCamZmZmZkTQDMzMzMzMx1AzczMzMzMGkDNzMzMzMwcQAAAAAAAABpAmpmZmZmZGUAzMzMzMzMbQM3MzMzMzBZAMzMzMzMzF0CamZmZmZkZQAAAAAAAABpAzczMzMzMHkDNzMzMzMweQAAAAAAAABhAmpmZmZmZG0BmZmZmZmYWQM3MzMzMzB5AMzMzMzMzGUDNzMzMzMwaQM3MzMzMzBxAzczMzMzMGEBmZmZmZmYYQJqZmZmZmRlAzczMzMzMHECamZmZmZkdQJqZmZmZmR9AmpmZmZmZGUAzMzMzMzMZQGZmZmZmZhhAzczMzMzMHkAzMzMzMzMZQJqZmZmZmRlAAAAAAAAAGECamZmZmZkbQM3MzMzMzBpAmpmZmZmZG0AzMzMzMzMXQDMzMzMzMxtAzczMzMzMGkDNzMzMzMwaQDMzMzMzMxlAAAAAAAAAGkDNzMzMzMwYQJqZmZmZmRdA","dtype":"float64","order":"little","shape":[150]},"sepal width in cm":{"__ndarray__":"AAAAAAAADEAAAAAAAAAIQJqZmZmZmQlAzczMzMzMCEDNzMzMzMwMQDMzMzMzMw9AMzMzMzMzC0AzMzMzMzMLQDMzMzMzMwdAzczMzMzMCECamZmZmZkNQDMzMzMzMwtAAAAAAAAACEAAAAAAAAAIQAAAAAAAABBAmpmZmZmZEUAzMzMzMzMPQAAAAAAAAAxAZmZmZmZmDkBmZmZmZmYOQDMzMzMzMwtAmpmZmZmZDUDNzMzMzMwMQGZmZmZmZgpAMzMzMzMzC0AAAAAAAAAIQDMzMzMzMwtAAAAAAAAADEAzMzMzMzMLQJqZmZmZmQlAzczMzMzMCEAzMzMzMzMLQGZmZmZmZhBAzczMzMzMEEDNzMzMzMwIQJqZmZmZmQlAAAAAAAAADEDNzMzMzMwMQAAAAAAAAAhAMzMzMzMzC0AAAAAAAAAMQGZmZmZmZgJAmpmZmZmZCUAAAAAAAAAMQGZmZmZmZg5AAAAAAAAACEBmZmZmZmYOQJqZmZmZmQlAmpmZmZmZDUBmZmZmZmYKQJqZmZmZmQlAmpmZmZmZCUDNzMzMzMwIQGZmZmZmZgJAZmZmZmZmBkBmZmZmZmYGQGZmZmZmZgpAMzMzMzMzA0AzMzMzMzMHQJqZmZmZmQVAAAAAAAAAAEAAAAAAAAAIQJqZmZmZmQFAMzMzMzMzB0AzMzMzMzMHQM3MzMzMzAhAAAAAAAAACECamZmZmZkFQJqZmZmZmQFAAAAAAAAABECamZmZmZkJQGZmZmZmZgZAAAAAAAAABEBmZmZmZmYGQDMzMzMzMwdAAAAAAAAACEBmZmZmZmYGQAAAAAAAAAhAMzMzMzMzB0DNzMzMzMwEQDMzMzMzMwNAMzMzMzMzA0CamZmZmZkFQJqZmZmZmQVAAAAAAAAACEAzMzMzMzMLQM3MzMzMzAhAZmZmZmZmAkAAAAAAAAAIQAAAAAAAAARAzczMzMzMBEAAAAAAAAAIQM3MzMzMzARAZmZmZmZmAkCamZmZmZkFQAAAAAAAAAhAMzMzMzMzB0AzMzMzMzMHQAAAAAAAAARAZmZmZmZmBkBmZmZmZmYKQJqZmZmZmQVAAAAAAAAACEAzMzMzMzMHQAAAAAAAAAhAAAAAAAAACEAAAAAAAAAEQDMzMzMzMwdAAAAAAAAABEDNzMzMzMwMQJqZmZmZmQlAmpmZmZmZBUAAAAAAAAAIQAAAAAAAAARAZmZmZmZmBkCamZmZmZkJQAAAAAAAAAhAZmZmZmZmDkDNzMzMzMwEQJqZmZmZmQFAmpmZmZmZCUBmZmZmZmYGQGZmZmZmZgZAmpmZmZmZBUBmZmZmZmYKQJqZmZmZmQlAZmZmZmZmBkAAAAAAAAAIQGZmZmZmZgZAAAAAAAAACEBmZmZmZmYGQGZmZmZmZg5AZmZmZmZmBkBmZmZmZmYGQM3MzMzMzARAAAAAAAAACEAzMzMzMzMLQM3MzMzMzAhAAAAAAAAACEDNzMzMzMwIQM3MzMzMzAhAzczMzMzMCECamZmZmZkFQJqZmZmZmQlAZmZmZmZmCkAAAAAAAAAIQAAAAAAAAARAAAAAAAAACEAzMzMzMzMLQAAAAAAAAAhA","dtype":"float64","order":"little","shape":[150]},"x":{"__ndarray__":"8xmHQfXYgUG2ZYRBVXaEQR6hhUHIm4NBvImIQU2EiEGDr4VBECyEQYDEhUGuXYlB2MyBQVjmg0GuKYNBT2eCQebghEFX6IZB6IyEQRxTgkEVN4lBfNWDQXdviEERk4pBBn6IQf3sgkHvo4pBH2WHQaLqiEEghoVBIwaEQUGliEEZAoFB2uSBQYvwgkGdboVBp66GQWLmhEHZC4VBozuJQR6PhkHg04JBbq2FQbcwikG/aYFBEVKCQWW0gUG0h4ZBRJ+DQflDh0EPuV6+o1rwvYsA7r4trwpAeo+kvp/kuD+LKA+/PWg8QBni6r0fzQdA77s3QKoDgT8pjBZAxFO/vp4qD0Cjqmc8k5SRPwUCBUA1EHK/BDAVQG1Inr+x2mQ/5Ii8vzVoMb5qlr49A0u9vNu8oL58QVC/6f9vvU0VHED5cCFATcwcQAofDEDr2/K/N/CvPxCPDr+Jday+GugXvzTHyD9fOQlAr53LP74JtL0JiwVAmFk1QNiq4D/XJqw/3c20P9OUiD5jSjFAYYPeP56Nd8BQufG/XPKQwG9tQMAwhXTAvbGrwA080D+1kKDA0CNdwJbIhcDuijPAgRU0wEMcZsBUXgrAR0cHwMw/SsBgn0bANkyawD3KpcAPttG/aJd8wEkn9b/QaabAgOrIv6gyfcDlqJnAwVKyvxrVs7/ZcVfAOeaawOiJosCZpp/AT6FcwDbp7b9k7BPA3gilwGXrbMA43kzAlMewv/C6WsAgtG/AoERMwDHD+79Xw37AVBGCwIpCS8AB2NO/mMg2wOPNV8ACu9C/","dtype":"float32","order":"little","shape":[150]},"y":{"__ndarray__":"1EnTQJb/AUEDZQ1BwEIJQe4b20B1KLRA6sYIQf5y5UDxlQ9BCDIBQTxCu0BLkvFA+UQGQbt2DkF9fatAgbCyQCyMtUAudNdAjFeyQKTyxEA3qcNA+9fLQNjcBEEjc91AWin1QLq3AUEh999AGOTKQKtxzEBRhwNBGuMCQQIkxEDJFLpA+L6wQPWFAEEYTO9Avoq6QAwv3EB5Vw5BLpDWQEX13UCb7wtBznkNQZrU3EDkmMVARo0FQVmExUDYJgpBq1DAQEQg60DPWxdAlCzlP+1PIUBahjM/n9n1P+8wuT95GbM/ieTWPmRoC0B5Nt4+lDrxPkNamD88aqY/YtKzPwF9Jj85zAlAhNmXP9ltsz88atg/yWtjP1ucfT9grbM/FITvP0utwz+V1+I/y2EDQOG1HEBYkCdArS+ZP4+WYT8paU4/ryUyP+A5iT+/HL0/iBFjP9SZjT8eEBZAjpLUP5lFmT820Ac/fDCSP32apj9LzJY/9cn/Ps3BpD+HkKM/SOGuP6rRvD9SAxc/e+ySPz/nbEDjk2s/av+EQHk2NEADaVNAo+eQQJ4fMT/iSoVAQoE9QFIXiEAYGltAwIE0QLOOYECkMoM/9cJoP8AzZ0A9BD5APy+SQEHpi0BMEOg/HiCGQFEsUD9ygIxAYE/aP1A+g0C/+4JAG2C5P7/thz+DN0RAAxCBQChOhkDnzo5Av3FKQPn49D/NsAVAv9SKQCelb0Ayrz1ATsGBP/I6eUATg4FA+0VzQAovhT/0RIVACyWAQD7XbUDLieU/3O1PQGiTZEDUPH0/","dtype":"float32","order":"little","shape":[150]}},"selected":{"id":"1052"},"selection_policy":{"id":"1051"}},"id":"1003","type":"ColumnDataSource"},{"attributes":{"overlay":{"id":"1027"}},"id":"1023","type":"BoxZoomTool"},{"attributes":{},"id":"1021","type":"PanTool"},{"attributes":{"fill_alpha":{"value":0.1},"fill_color":{"field":"color"},"hatch_alpha":{"value":0.1},"hatch_color":{"field":"color"},"line_alpha":{"value":0.1},"line_color":{"field":"color"},"size":{"value":10},"x":{"field":"x"},"y":{"field":"y"}},"id":"1039","type":"Circle"},{"attributes":{"axis":{"id":"1017"},"coordinates":null,"dimension":1,"group":null,"ticker":null,"visible":false},"id":"1020","type":"Grid"},{"attributes":{"coordinates":null,"data_source":{"id":"1003"},"glyph":{"id":"1038"},"group":null,"hover_glyph":null,"muted_glyph":{"id":"1040"},"nonselection_glyph":{"id":"1039"},"view":{"id":"1042"}},"id":"1041","type":"GlyphRenderer"},{"attributes":{"fill_alpha":{"field":"alpha"},"fill_color":{"field":"color"},"hatch_alpha":{"field":"alpha"},"hatch_color":{"field":"color"},"line_alpha":{"field":"alpha"},"line_color":{"field":"color"},"size":{"value":10},"x":{"field":"x"},"y":{"field":"y"}},"id":"1038","type":"Circle"},{"attributes":{},"id":"1046","type":"BasicTickFormatter"},{"attributes":{},"id":"1022","type":"WheelZoomTool"},{"attributes":{"callback":null,"tooltips":[["index","@{index}"],["label","@{label}"],["sepal length in cm","@{sepal length in cm}"],["sepal width in cm","@{sepal width in cm}"],["petal length in cm","@{petal length in cm}"],["petal width in cm","@{petal width in cm}"],["item","@{item}"]]},"id":"1028","type":"HoverTool"},{"attributes":{},"id":"1014","type":"BasicTicker"},{"attributes":{},"id":"1011","type":"LinearScale"},{"attributes":{"coordinates":null,"formatter":{"id":"1049"},"group":null,"major_label_policy":{"id":"1050"},"ticker":{"id":"1014"},"visible":false},"id":"1013","type":"LinearAxis"},{"attributes":{"coordinates":null,"formatter":{"id":"1046"},"group":null,"major_label_policy":{"id":"1047"},"ticker":{"id":"1018"},"visible":false},"id":"1017","type":"LinearAxis"},{"attributes":{"bottom_units":"screen","coordinates":null,"fill_alpha":0.5,"fill_color":"lightgrey","group":null,"left_units":"screen","level":"overlay","line_alpha":1.0,"line_color":"black","line_dash":[4,4],"line_width":2,"right_units":"screen","syncable":false,"top_units":"screen"},"id":"1027","type":"BoxAnnotation"},{"attributes":{"fill_alpha":{"value":0.2},"fill_color":{"field":"color"},"hatch_alpha":{"value":0.2},"hatch_color":{"field":"color"},"line_alpha":{"value":0.2},"line_color":{"field":"color"},"size":{"value":10},"x":{"field":"x"},"y":{"field":"y"}},"id":"1040","type":"Circle"},{"attributes":{"coordinates":null,"group":null},"id":"1043","type":"Title"},{"attributes":{},"id":"1047","type":"AllLabels"},{"attributes":{},"id":"1009","type":"LinearScale"},{"attributes":{},"id":"1026","type":"HelpTool"},{"attributes":{},"id":"1024","type":"SaveTool"},{"attributes":{"tools":[{"id":"1021"},{"id":"1022"},{"id":"1023"},{"id":"1024"},{"id":"1025"},{"id":"1026"},{"id":"1028"}]},"id":"1029","type":"Toolbar"},{"attributes":{"axis":{"id":"1013"},"coordinates":null,"group":null,"ticker":null,"visible":false},"id":"1016","type":"Grid"},{"attributes":{},"id":"1007","type":"DataRange1d"},{"attributes":{},"id":"1051","type":"UnionRenderers"},{"attributes":{},"id":"1049","type":"BasicTickFormatter"},{"attributes":{},"id":"1018","type":"BasicTicker"},{"attributes":{},"id":"1052","type":"Selection"},{"attributes":{},"id":"1005","type":"DataRange1d"},{"attributes":{"source":{"id":"1003"}},"id":"1042","type":"CDSView"},{"attributes":{},"id":"1025","type":"ResetTool"}],"root_ids":["1004"]},"title":"Bokeh Application","version":"2.4.3"}};
  const render_items = [{"docid":"0d082026-3fc7-4b58-bd70-e25a8cd6beff","root_ids":["1004"],"roots":{"1004":"46f488ba-6a79-4f60-850a-f9e852d893e7"}}];
  root.Bokeh.embed.embed_items_notebook(docs_json, render_items);
  }
  if (root.Bokeh !== undefined) {
    embed_document(root);
  } else {
    let attempts = 0;
    const timer = setInterval(function(root) {
      if (root.Bokeh !== undefined) {
        clearInterval(timer);
        embed_document(root);
      } else {
        attempts++;
        if (attempts > 100) {
          clearInterval(timer);
          console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
        }
      }
    }, 10, root)
  }
})(window);</script></div>
</div>
</section>
</section>
<section id="id29">
<h2>Использование понижения размерности для ускорения обучения<a class="headerlink" href="#id29" title="Permalink to this heading">#</a></h2>
<p>Рассмотрите набор данных TissueMNIST. В этом задании вам нужно сравнить производительность двух моделей: обученной с использованием всех доступных признаков и обученной на данных пониженной размерности. От вас требуется:</p>
<ol class="arabic simple">
<li><p>Посторить модель <code class="docutils literal notranslate"><span class="pre">RandomForestClassifier()</span></code> и обучить ее на тренировочной выборке, оценить <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> модели на тестовой выборке и время, потраченное на обучение;</p></li>
<li><p>Построить модель PCA на тернировочных данных и определите число главных компонент, объясняющих 90% дисперсии (или используйте любой другой способ выбора оптимального числа главных компонент, разбиравшийся на лекции);</p></li>
<li><p>Спроецировать данные тестовой выборки на главные компоненты, полученной модели PCA;</p></li>
<li><p>Построить модель <code class="docutils literal notranslate"><span class="pre">RandomForestClassifier()</span></code> и обучить ее на данных пониженной размерности, оценить <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> модели на тестовой выборке и время, потраченное на обучение;</p></li>
<li><p>Опишите ваши наблюдения, сделайте выводы.</p></li>
</ol>
<p><em>Note: Обратите внимание, что параметр <code class="docutils literal notranslate"><span class="pre">n_components</span></code> при создании экземпляра класса <code class="docutils literal notranslate"><span class="pre">PCA</span></code> может принимать не только целочисленные значения (непосредственно количество компонент в “штуках”), но и вещественные на интервале <span class="math notranslate nohighlight">\((0, 1)\)</span>. Ознакомьтесь с описанием класса <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html"><code class="docutils literal notranslate"><span class="pre">sklearn.decomposition.PCA</span></code></a> и определите как можно использовать вещественное <code class="docutils literal notranslate"><span class="pre">n_components</span></code> для решения задачи.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="n">data_flag</span> <span class="o">=</span> <span class="s1">&#39;tissuemnist&#39;</span>
<span class="n">download</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">info</span> <span class="o">=</span> <span class="n">INFO</span><span class="p">[</span><span class="n">data_flag</span><span class="p">]</span>
<span class="n">task</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span>
<span class="n">n_channels</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;n_channels&#39;</span><span class="p">]</span>
<span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>

<span class="n">DataClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dataset_without_pytorch</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;python_class&#39;</span><span class="p">])</span>

<span class="c1"># load the data</span>
<span class="n">tissuemnist</span> <span class="o">=</span> <span class="n">DataClass</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tissuemnist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading https://zenodo.org/record/6496656/files/tissuemnist.npz?download=1 to /root/.medmnist/tissuemnist.npz
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "055585208da746f18069a99812453604", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset TissueMNIST (tissuemnist)
    Number of datapoints: 47280
    Root location: /root/.medmnist
    Split: test
    Task: multi-class
    Number of channels: 1
    Meaning of labels: {&#39;0&#39;: &#39;Collecting Duct, Connecting Tubule&#39;, &#39;1&#39;: &#39;Distal Convoluted Tubule&#39;, &#39;2&#39;: &#39;Glomerular endothelial cells&#39;, &#39;3&#39;: &#39;Interstitial endothelial cells&#39;, &#39;4&#39;: &#39;Leukocytes&#39;, &#39;5&#39;: &#39;Podocytes&#39;, &#39;6&#39;: &#39;Proximal Tubule Segments&#39;, &#39;7&#39;: &#39;Thick Ascending Limb&#39;}
    Number of samples: {&#39;train&#39;: 165466, &#39;val&#39;: 23640, &#39;test&#39;: 47280}
    Description: We use the BBBC051, available from the Broad Bioimage Benchmark Collection. The dataset contains 236,386 human kidney cortex cells, segmented from 3 reference tissue specimens and organized into 8 categories. We split the source dataset with a ratio of 7:1:2 into training, validation and test set. Each gray-scale image is 32×32×7 pixels, where 7 denotes 7 slices. We take maximum values across the slices and resize them into 28×28 gray-scale images.
    License: CC BY 4.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tissuemnist</span><span class="o">.</span><span class="n">imgs</span> <span class="o">/</span> <span class="mf">255.</span> <span class="c1"># normalization data</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">784</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">tissuemnist</span><span class="o">.</span><span class="n">labels</span>
 
<span class="n">tissuemnist</span><span class="o">.</span><span class="n">montage</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span><span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acc of default rf&#39;</span><span class="p">,</span> <span class="n">acc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>acc of default rf 0.5221023688663282
CPU times: user 3min 14s, sys: 782 ms, total: 3min 14s
Wall time: 3min 14s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">pca_0_9</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">)</span> 
<span class="c1">#projecting data to reduced dimension</span>
<span class="n">pca_0_9</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
<span class="n">X_PCA_train</span> <span class="o">=</span> <span class="n">pca_0_9</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">x_train</span><span class="p">))</span>
<span class="n">X_PCA_test</span> <span class="o">=</span> <span class="n">pca_0_9</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">x_test</span><span class="p">))</span>
<span class="n">n_compp_0_9</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_PCA_train</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;optimal number of dim to save more than 90</span><span class="si">% o</span><span class="s1">f dispersion&#39;</span><span class="p">,</span><span class="n">n_compp_0_9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>optimal number of dim to save more than 90% of dispersion 58
CPU times: user 15.1 s, sys: 2.42 s, total: 17.5 s
Wall time: 15.3 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">rf_PCA</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">rf_PCA</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_PCA_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">predict</span> <span class="o">=</span> <span class="n">rf_PCA</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_PCA_test</span><span class="p">)</span>
<span class="n">acc_PCA</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span><span class="n">predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;acc of default rf&#39;</span><span class="p">,</span> <span class="n">acc_PCA</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>acc of default rf 0.503489847715736
CPU times: user 1min 27s, sys: 543 ms, total: 1min 27s
Wall time: 1min 27s
</pre></div>
</div>
</div>
</div>
<p><em>Вывод:</em></p>
<p>кол-во компонент,необходимых для сохраения 90% дисперсии данных оказался равен 58, что более, чем в 13 раз меньше, чем исходная размерность (784).
При этом время обучения rf на данных пониженной размерности стало вдвое меньше (3 мин 14 с vs 1 мин 27 с), а качество предсказания accuracy уменьшилось менее, чем на 0.02 (0.5034 vs 0.522), что довольно незначительно, учитывая прирост по времени более, чем в 2 раза.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./upd_07_09_23/sems_upd"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Кластеризация</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Методы понижения размерности</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pca">PCA (Метод главных компонент)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Максимизация дисперсии выборки после понижения размерности</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Пример с Титаником</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Без стандартизации</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Со стандартизацией</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Как выбирать оптимальное число  компонент</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">По доле объясняемой дисперсии</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">По правилу локтя</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Перестановочный метод</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Проблемы  PCA</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Интересное направление в данных может не совпадать с направлением максимальной дисперсии.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Выбранные оси могут вообще не подходить для нашей задачи</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Недостатки линейного PCA</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-pca">Kernel PCA Ядровой (нелинейный) метод главных компонент</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-trick">Kernel trick</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Пример</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Методы, основанные на сохранении расстояний</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne-t-distributed-stochastic-neighbor-embedding">t-SNE (t-distributed stochastic neighbor embedding)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Описываем расстояния в исходном пространстве</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Описываем расстояния в пространстве низкой размерности</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Оптимизируем низкоразмерное представление</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Пример применения</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#t-sne">Важные параметры t-SNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#perplexity">perplexity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#metric">metric</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-rate">learning_rate</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Проблемы t-SNE</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Стохастичность</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Добавление новых точек</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">Расстояния между кластерами точек могут ничего не значить (плохо сохраняются далекие расстояния)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Размеры кластеров ничего не значат</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Можно увидеть артефактные кластеры</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Можно увидеть не ту структуру, которая по идее должна быть</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">Использование для кластеризации</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#umap">UMAP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap-iris">UMAP - пример использования на датасете IRIS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Использование понижения размерности для ускорения обучения</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Belyakcoff N., Pepa R.
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>